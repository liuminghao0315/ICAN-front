# 高校内容创作者行为分析平台 - 数据库设计文档

> 数据库：MySQL 8.0  
> 字符集：utf8mb4  
> 排序规则：utf8mb4_unicode_ci

---

## 📊 ER图

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    user     │       │     video       │       │  analysis_task  │
├─────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)     │◄──────┤ user_id (FK)    │       │ id (PK)         │
│ name        │       │ id (PK)         │◄──────┤ video_id (FK)   │
│ password    │       │ title           │       │ user_id (FK)    │──────►┌─────────────┐
│ email       │       │ description     │       │ task_type       │       │    user     │
│ gmt_created │       │ file_name       │       │ status          │       └─────────────┘
│ gmt_modified│       │ file_path       │       │ progress        │
└─────────────┘       │ file_size       │       │ error_message   │
                      │ file_type       │       │ started_at      │
                      │ duration        │       │ completed_at    │
                      │ width           │       │ gmt_created     │
                      │ height          │       │ gmt_modified    │
                      │ thumbnail_path  │       └────────┬────────┘
                      │ status          │                │
                      │ gmt_created     │                │
                      │ gmt_modified    │                ▼
                      └─────────────────┘       ┌─────────────────┐
                                                │ analysis_result │
                                                ├─────────────────┤
                                                │ id (PK)         │
                                                │ task_id (FK)    │
                                                │ video_id (FK)   │
                                                │ risk_score      │
                                                │ risk_level      │
                                                │ ... (更多字段)   │
                                                │ gmt_created     │
                                                │ gmt_modified    │
                                                └─────────────────┘

┌───────────────────┐       ┌───────────────────┐
│ upload_statistics │       │   upload_chunk    │
├───────────────────┤       ├───────────────────┤
│ id (PK)           │       │ id (PK)           │
│ user_id (FK)      │       │ file_identifier   │
│ file_count        │       │ chunk_number      │
│ total_size        │       │ user_id (FK)      │
│ stat_date         │       │ file_name         │
│ gmt_created       │       │ total_chunks      │
│ gmt_modified      │       │ total_size        │
└───────────────────┘       │ chunk_path        │
                            │ uploaded          │
                            │ gmt_created       │
                            │ gmt_modified      │
                            └───────────────────┘
```

---

## 📋 表结构详细说明

### 1. user（用户表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | VARCHAR(36) | PRIMARY KEY | - | 用户ID（UUID） |
| name | VARCHAR(50) | NOT NULL, UNIQUE | - | 用户名 |
| password | VARCHAR(255) | NOT NULL | - | 密码（BCrypt加密） |
| email | VARCHAR(100) | NOT NULL, UNIQUE | - | 邮箱地址 |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**索引：**
- `idx_user_name` - name 字段索引（登录查询优化）
- `idx_user_email` - email 字段索引（邮箱查询优化）

**示例数据：**
```sql
INSERT INTO user (id, name, password, email, gmt_created, gmt_modified) VALUES
('550e8400-e29b-41d4-a716-446655440001', 'testuser', '$2a$10$...', 'test@qq.com', NOW(), NOW());
```

---

### 2. video（视频表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | VARCHAR(36) | PRIMARY KEY | - | 视频ID（UUID） |
| user_id | VARCHAR(36) | NOT NULL, FK | - | 上传用户ID |
| title | VARCHAR(200) | NOT NULL | - | 视频标题 |
| description | TEXT | NULL | NULL | 视频描述 |
| file_name | VARCHAR(255) | NOT NULL | - | 原始文件名 |
| file_path | VARCHAR(500) | NOT NULL | - | MinIO存储路径 |
| file_size | BIGINT | NOT NULL | - | 文件大小（字节） |
| file_type | VARCHAR(50) | NULL | NULL | 文件MIME类型 |
| duration | DOUBLE | NULL | NULL | 视频时长（秒） |
| width | INT | NULL | NULL | 视频宽度（像素） |
| height | INT | NULL | NULL | 视频高度（像素） |
| thumbnail_path | VARCHAR(500) | NULL | NULL | 缩略图存储路径 |
| status | VARCHAR(20) | NOT NULL | 'UPLOADED' | 视频状态 |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**状态值说明：**
| 状态 | 说明 |
|------|------|
| UPLOADED | 已上传，等待分析 |
| ANALYZING | 正在分析中 |
| COMPLETED | 分析完成 |
| FAILED | 分析失败 |

**索引：**
- `idx_video_user_id` - user_id 字段索引
- `idx_video_status` - status 字段索引
- `idx_video_created` - gmt_created 字段索引（按时间排序）

**外键约束：**
```sql
FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
```

---

### 3. analysis_task（分析任务表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | VARCHAR(36) | PRIMARY KEY | - | 任务ID（UUID） |
| video_id | VARCHAR(36) | NOT NULL, FK | - | 关联视频ID |
| user_id | VARCHAR(36) | NOT NULL, FK | - | 创建用户ID |
| task_type | VARCHAR(50) | NOT NULL | 'FULL_ANALYSIS' | 任务类型 |
| status | VARCHAR(20) | NOT NULL | 'PENDING' | 任务状态 |
| progress | INT | NOT NULL | 0 | 处理进度(0-100) |
| error_message | TEXT | NULL | NULL | 错误信息 |
| started_at | DATETIME | NULL | NULL | 开始处理时间 |
| completed_at | DATETIME | NULL | NULL | 完成时间 |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**任务类型说明：**
| 类型 | 说明 |
|------|------|
| FULL_ANALYSIS | 完整分析（视频+音频+文本） |
| VIDEO_ONLY | 仅视频分析 |
| AUDIO_ONLY | 仅音频分析 |
| TEXT_ONLY | 仅文本分析 |

**任务状态说明：**
| 状态 | 说明 |
|------|------|
| PENDING | 等待处理 |
| PROCESSING | 处理中 |
| COMPLETED | 已完成 |
| FAILED | 失败 |
| CANCELLED | 已取消 |

**索引：**
- `idx_task_video_id` - video_id 字段索引
- `idx_task_user_id` - user_id 字段索引
- `idx_task_status` - status 字段索引
- `idx_task_created` - gmt_created 字段索引

**外键约束：**
```sql
FOREIGN KEY (video_id) REFERENCES video(id) ON DELETE CASCADE,
FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
```

---

### 4. analysis_result（分析结果表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | VARCHAR(36) | PRIMARY KEY | - | 结果ID（UUID） |
| task_id | VARCHAR(36) | NOT NULL, FK, UNIQUE | - | 关联任务ID（一对一） |
| video_id | VARCHAR(36) | NOT NULL, FK | - | 关联视频ID |
| risk_score | DECIMAL(5,4) | NULL | NULL | 综合风险评分(0-1) |
| risk_level | VARCHAR(20) | NULL | NULL | 风险等级 |
| is_university_related | TINYINT(1) | NULL | NULL | 是否高校相关 |
| university_name | VARCHAR(100) | NULL | NULL | 高校名称 |
| university_confidence | DECIMAL(5,4) | NULL | NULL | 高校识别置信度 |
| topic_category | VARCHAR(50) | NULL | NULL | 主题分类 |
| topic_keywords | JSON | NULL | NULL | 主题关键词(JSON数组) |
| sentiment_score | DECIMAL(5,4) | NULL | NULL | 情感评分(-1到1) |
| sentiment_label | VARCHAR(20) | NULL | NULL | 情感标签 |
| video_features | JSON | NULL | NULL | 视频特征(JSON对象) |
| audio_features | JSON | NULL | NULL | 音频特征(JSON对象) |
| transcription | TEXT | NULL | NULL | 语音转文字结果 |
| text_features | JSON | NULL | NULL | 文本特征(JSON对象) |
| audience_analysis | JSON | NULL | NULL | 受众分析(JSON对象) |
| spread_potential | DECIMAL(5,4) | NULL | NULL | 传播潜力评分(0-1) |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**风险等级说明：**
| 等级 | 分数范围 | 说明 |
|------|----------|------|
| LOW | 0.00 - 0.30 | 低风险，内容安全 |
| MEDIUM | 0.30 - 0.70 | 中风险，需人工审核 |
| HIGH | 0.70 - 1.00 | 高风险，建议下架 |

**情感标签说明：**
| 标签 | 分数范围 | 说明 |
|------|----------|------|
| NEGATIVE | -1.00 ~ -0.30 | 负面情感 |
| NEUTRAL | -0.30 ~ 0.30 | 中性情感 |
| POSITIVE | 0.30 ~ 1.00 | 正面情感 |

**JSON字段示例：**

**topic_keywords:**
```json
["大学生", "校园", "青春", "学习"]
```

**video_features:**
```json
{
  "duration": 120.5,
  "width": 1920,
  "height": 1080,
  "fps": 30,
  "sceneType": "教室",
  "sceneConfidence": 0.88,
  "faceCount": 3,
  "hasPerson": true,
  "qualityScore": 0.85,
  "brightness": 0.65,
  "clarity": 0.92
}
```

**audio_features:**
```json
{
  "hasAudio": true,
  "audioQuality": 0.78,
  "speechRatio": 0.65,
  "musicRatio": 0.15,
  "noiseLevel": 0.12,
  "volumeLevel": 0.68,
  "emotionInVoice": "calm"
}
```

**text_features:**
```json
{
  "titleLength": 10,
  "hasDescription": true,
  "descriptionLength": 50,
  "titleSentiment": 0.3,
  "containsKeywords": true,
  "languageConfidence": 0.98
}
```

**audience_analysis:**
```json
{
  "ageDistribution": {
    "18-24": 0.55,
    "25-34": 0.30,
    "35-44": 0.10,
    "45+": 0.05
  },
  "predictedInterests": ["教育", "校园生活", "青年文化"],
  "predictedViews": 5000,
  "predictedEngagement": 0.08
}
```

**索引：**
- `idx_result_task_id` - task_id 字段唯一索引
- `idx_result_video_id` - video_id 字段索引
- `idx_result_risk_level` - risk_level 字段索引
- `idx_result_created` - gmt_created 字段索引

**外键约束：**
```sql
FOREIGN KEY (task_id) REFERENCES analysis_task(id) ON DELETE CASCADE,
FOREIGN KEY (video_id) REFERENCES video(id) ON DELETE CASCADE
```

---

### 5. upload_statistics（上传统计表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | VARCHAR(36) | NOT NULL, FK | - | 用户ID |
| file_count | INT | NOT NULL | 0 | 当日上传文件数 |
| total_size | BIGINT | NOT NULL | 0 | 当日上传总大小(字节) |
| stat_date | DATE | NOT NULL | - | 统计日期 |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**唯一约束：**
```sql
UNIQUE KEY uk_user_date (user_id, stat_date)
```

**索引：**
- `idx_stat_user_id` - user_id 字段索引
- `idx_stat_date` - stat_date 字段索引

---

### 6. upload_chunk（分片上传记录表）

| 字段 | 类型 | 约束 | 默认值 | 说明 |
|------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| file_identifier | VARCHAR(64) | NOT NULL | - | 文件MD5标识 |
| chunk_number | INT | NOT NULL | - | 分片序号（从1开始） |
| user_id | VARCHAR(36) | NOT NULL, FK | - | 上传用户ID |
| file_name | VARCHAR(255) | NOT NULL | - | 原始文件名 |
| total_chunks | INT | NOT NULL | - | 总分片数 |
| total_size | BIGINT | NOT NULL | - | 文件总大小 |
| chunk_path | VARCHAR(500) | NULL | NULL | 分片临时存储路径 |
| uploaded | TINYINT(1) | NOT NULL | 0 | 是否已上传(0/1) |
| gmt_created | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| gmt_modified | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 修改时间 |

**唯一约束：**
```sql
UNIQUE KEY uk_identifier_chunk (file_identifier, chunk_number)
```

**索引：**
- `idx_chunk_identifier` - file_identifier 字段索引
- `idx_chunk_user_id` - user_id 字段索引

---

## 🔧 完整建表SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS ican DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE ican;

-- 用户表
CREATE TABLE IF NOT EXISTS `user` (
    `id` VARCHAR(36) NOT NULL,
    `name` VARCHAR(50) NOT NULL,
    `password` VARCHAR(255) NOT NULL,
    `email` VARCHAR(100) NOT NULL,
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_name` (`name`),
    UNIQUE KEY `uk_user_email` (`email`),
    INDEX `idx_user_name` (`name`),
    INDEX `idx_user_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 视频表
CREATE TABLE IF NOT EXISTS `video` (
    `id` VARCHAR(36) NOT NULL,
    `user_id` VARCHAR(36) NOT NULL,
    `title` VARCHAR(200) NOT NULL,
    `description` TEXT,
    `file_name` VARCHAR(255) NOT NULL,
    `file_path` VARCHAR(500) NOT NULL,
    `file_size` BIGINT NOT NULL,
    `file_type` VARCHAR(50),
    `duration` DOUBLE,
    `width` INT,
    `height` INT,
    `thumbnail_path` VARCHAR(500),
    `status` VARCHAR(20) NOT NULL DEFAULT 'UPLOADED',
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    INDEX `idx_video_user_id` (`user_id`),
    INDEX `idx_video_status` (`status`),
    INDEX `idx_video_created` (`gmt_created`),
    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频表';

-- 分析任务表
CREATE TABLE IF NOT EXISTS `analysis_task` (
    `id` VARCHAR(36) NOT NULL,
    `video_id` VARCHAR(36) NOT NULL,
    `user_id` VARCHAR(36) NOT NULL,
    `task_type` VARCHAR(50) NOT NULL DEFAULT 'FULL_ANALYSIS',
    `status` VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    `progress` INT NOT NULL DEFAULT 0,
    `error_message` TEXT,
    `started_at` DATETIME,
    `completed_at` DATETIME,
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    INDEX `idx_task_video_id` (`video_id`),
    INDEX `idx_task_user_id` (`user_id`),
    INDEX `idx_task_status` (`status`),
    INDEX `idx_task_created` (`gmt_created`),
    FOREIGN KEY (`video_id`) REFERENCES `video`(`id`) ON DELETE CASCADE,
    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分析任务表';

-- 分析结果表
CREATE TABLE IF NOT EXISTS `analysis_result` (
    `id` VARCHAR(36) NOT NULL,
    `task_id` VARCHAR(36) NOT NULL,
    `video_id` VARCHAR(36) NOT NULL,
    `risk_score` DECIMAL(5,4),
    `risk_level` VARCHAR(20),
    `is_university_related` TINYINT(1),
    `university_name` VARCHAR(100),
    `university_confidence` DECIMAL(5,4),
    `topic_category` VARCHAR(50),
    `topic_keywords` JSON,
    `sentiment_score` DECIMAL(5,4),
    `sentiment_label` VARCHAR(20),
    `video_features` JSON,
    `audio_features` JSON,
    `transcription` TEXT,
    `text_features` JSON,
    `audience_analysis` JSON,
    `spread_potential` DECIMAL(5,4),
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_result_task_id` (`task_id`),
    INDEX `idx_result_video_id` (`video_id`),
    INDEX `idx_result_risk_level` (`risk_level`),
    INDEX `idx_result_created` (`gmt_created`),
    FOREIGN KEY (`task_id`) REFERENCES `analysis_task`(`id`) ON DELETE CASCADE,
    FOREIGN KEY (`video_id`) REFERENCES `video`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分析结果表';

-- 上传统计表
CREATE TABLE IF NOT EXISTS `upload_statistics` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `user_id` VARCHAR(36) NOT NULL,
    `file_count` INT NOT NULL DEFAULT 0,
    `total_size` BIGINT NOT NULL DEFAULT 0,
    `stat_date` DATE NOT NULL,
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_date` (`user_id`, `stat_date`),
    INDEX `idx_stat_user_id` (`user_id`),
    INDEX `idx_stat_date` (`stat_date`),
    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='上传统计表';

-- 分片上传记录表
CREATE TABLE IF NOT EXISTS `upload_chunk` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `file_identifier` VARCHAR(64) NOT NULL,
    `chunk_number` INT NOT NULL,
    `user_id` VARCHAR(36) NOT NULL,
    `file_name` VARCHAR(255) NOT NULL,
    `total_chunks` INT NOT NULL,
    `total_size` BIGINT NOT NULL,
    `chunk_path` VARCHAR(500),
    `uploaded` TINYINT(1) NOT NULL DEFAULT 0,
    `gmt_created` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `gmt_modified` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_identifier_chunk` (`file_identifier`, `chunk_number`),
    INDEX `idx_chunk_identifier` (`file_identifier`),
    INDEX `idx_chunk_user_id` (`user_id`),
    FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分片上传记录表';
```

---

## 📈 查询示例

### 获取用户的视频列表（带分析状态）

```sql
SELECT 
    v.id,
    v.title,
    v.file_name,
    v.file_size,
    v.status,
    v.gmt_created,
    t.id AS task_id,
    t.status AS task_status,
    t.progress,
    r.id AS result_id,
    r.risk_level
FROM video v
LEFT JOIN (
    SELECT video_id, id, status, progress
    FROM analysis_task
    WHERE (video_id, gmt_created) IN (
        SELECT video_id, MAX(gmt_created)
        FROM analysis_task
        GROUP BY video_id
    )
) t ON v.id = t.video_id
LEFT JOIN analysis_result r ON t.id = r.task_id
WHERE v.user_id = 'user_id_here'
ORDER BY v.gmt_created DESC;
```

### 获取风险分布统计

```sql
SELECT 
    risk_level,
    COUNT(*) as count
FROM analysis_result r
INNER JOIN analysis_task t ON r.task_id = t.id
WHERE t.user_id = 'user_id_here'
GROUP BY risk_level;
```

### 获取近7天上传趋势

```sql
SELECT 
    DATE(gmt_created) as upload_date,
    COUNT(*) as count,
    SUM(file_size) as total_size
FROM video
WHERE user_id = 'user_id_here'
  AND gmt_created >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY DATE(gmt_created)
ORDER BY upload_date;
```

---

## 🔒 数据完整性约束

1. **用户删除**：级联删除用户的所有视频、任务、结果、统计数据
2. **视频删除**：级联删除视频相关的任务和结果
3. **任务删除**：级联删除任务的结果

---

## 🚀 性能优化建议

1. **分区表**：对于 `video`、`analysis_task`、`analysis_result` 表，可按月份进行分区
2. **归档策略**：超过6个月的数据可归档到历史表
3. **索引优化**：根据实际查询模式添加复合索引
4. **JSON字段**：MySQL 8.0 支持 JSON 字段的虚拟列索引，可按需添加

